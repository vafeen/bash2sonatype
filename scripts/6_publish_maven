#!/bin/bash

# ===========================================
# ШАГ 6: ПУБЛИКАЦИЯ В MAVEN CENTRAL
# ===========================================

# ===========================================
# ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
# ===========================================

show_publication_info() {
    echo "Данные для публикации:"
    echo "----------------------"
    echo "Группа:       $GROUP_ID"
    echo "Артефакт:     $ARTIFACT_NAME"
    echo "Версия:       $VERSION"
    echo "Пакет:        $SOURCES_PACKAGE"
    echo "Репозиторий:  $REPOSITORY_URL"
    echo ""
}

confirm_publication() {
    read -p "Продолжить публикацию? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_success "Публикация отменена"
        exit 0
    fi
}

publish_to_sonatype_central() {
    local autopublish="${1:-false}"
    
    log_info "Загрузка в Sonatype Central..."
    
    # Создаем токен авторизации
    local token=$(echo -n "$SONATYPE_USERNAME:$SONATYPE_PASSWORD" | base64)

    if [ -z "$token" ]; then
        log_error "Не удалось создать токен авторизации"
        return 1
    fi

    # Определяем тип публикации
    local publishing_type="USER_MANAGED"
    [ "$autopublish" = "true" ] && publishing_type="AUTOMATIC"
    
    # Загружаем bundle
    local response
    response=$(curl --request POST \
        --silent \
        --show-error \
        --write-out "HTTP_STATUS:%{http_code}" \
        --header "Authorization: Bearer $token" \
        --form "bundle=@$BUNDLE_ZIP" \
        --form "publishingType=$publishing_type" \
        --form "name=${ARTIFACT_PREFIX}" \
        https://central.sonatype.com/api/v1/publisher/upload 2>&1)
    
    local exit_code=$?
    local http_status=$(echo "$response" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
    local body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')

    if [ $exit_code -eq 0 ] && { [ "$http_status" = "200" ] || [ "$http_status" = "201" ]; }; then
        log_success "✅ Bundle успешно загружен"
        echo "Deployment ID: $body"
        
        if [ "$autopublish" = "true" ]; then
            log_info "Автоматическая публикация запущена"
        else
            log_info "Требуется ручная публикация через UI"
        fi
        
        return 0
    else
        log_error "❌ Ошибка загрузки: HTTP $http_status"
        echo "$body"
        return 1
    fi
}

show_publication_success() {
    echo ""
    echo "Артефакты опубликованы:"
    echo "  • $FINAL_LIB_FILE"
    echo "  • $SOURCES_JAR"
    echo "  • $JAVADOC_JAR"
    echo ""

    if [ "$IS_SNAPSHOT" = "true" ]; then
        log_success "SNAPSHOT версия опубликована"
    else
        log_info "RELEASE версия в staging репозитории"
        echo "Для выпуска в Central:"
        echo "1. https://central.sonatype.com"
        echo "2. Найти staging репозиторий"
        echo "3. Close → Release"
    fi

    echo ""
    echo "Ссылка для проверки:"
    echo "https://repo1.maven.org/maven2/$(echo $GROUP_ID | tr '.' '/')/$ARTIFACT_NAME/$VERSION/"
}

show_publication_error() {
    log_error "Ошибка при публикации"
}

cleanup_after_publication() {
    log_info "Очистка временных файлов..."

    # Удаляем созданные файлы
    if rm -f "$POM_FILE" "$SETTINGS_FILE" 2>/dev/null; then
        log_success "Файлы удалены"
    else
        log_error "Ошибка удаления файлов"
        return 1
    fi

    # Удаляем подписи
    if rm -f "${FINAL_LIB_FILE}.asc" "${SOURCES_JAR}.asc" "${JAVADOC_JAR}.asc" "${POM_FILE}.asc" 2>/dev/null; then
        log_success "Подписи удалены"
    else
        log_error "Ошибка удаления подписей"
        return 1
    fi

    # Очищаем рабочую директорию
    if cleanup_work_dir; then
        log_success "Рабочая директория очищена"
    else
        log_error "Ошибка очистки рабочей директории"
        return 1
    fi

    return 0
}


# ===========================================
# ОСНОВНОЙ ВЫЗОВ ФУНКЦИЙ
# ===========================================

#log_step "5: Публикация в Maven Central"
#
## Показываем информацию о публикации
#show_publication_info
#
## Подтверждаем публикацию
#confirm_publication
#
## Проверяем файлы
#check_files_for_publication
#
## Выполняем публикацию
#perform_publication