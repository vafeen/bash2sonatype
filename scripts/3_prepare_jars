#!/bin/bash

# ===========================================
# ШАГ 2: ПОДГОТОВКА JAR ФАЙЛОВ
# ===========================================

# ===========================================
# ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
# ===========================================

create_sources_jar() {
    log_info "Создание sources JAR..."

    if [ -n "$SOURCE_CODE_PATH" ] && [ -d "$SOURCE_CODE_PATH" ]; then
        # Используем существующие исходники из указанного пути
        log_info "Использую исходники из: $SOURCE_CODE_PATH"
        jar cf "$SOURCES_JAR" -C "$SOURCE_CODE_PATH" .
        log_success "Создан sources JAR из исходников"
    else
        if [ -n "$SOURCE_CODE_PATH" ]; then
            log_warning "Директория с исходным кодом не найдена: $SOURCE_CODE_PATH"
        else
            log_warning "Путь к исходникам не указан (SOURCE_CODE_PATH)"
        fi

        log_info "Создание минимального sources JAR..."

        # Создаем минимальную структуру пакета
        # Используем SOURCES_PACKAGE вместо GROUP_ID
        PACKAGE_PATH=$(echo "$SOURCES_PACKAGE" | tr '.' '/')
        mkdir -p "$BUILD_DIR/sources/$PACKAGE_PATH"

        # Создаем package-info.java с описанием
        cat > "$BUILD_DIR/sources/$PACKAGE_PATH/package-info.java" << EOF
/**
 * ${ARTIFACT_ID} ${VERSION}
 *
 * <p>${PROJECT_DESCRIPTION}</p>
 *
 * <p>Generated sources for ${GROUP_ID}:${ARTIFACT_ID}:${VERSION}</p>
 *
 * @version ${VERSION}
 * @since ${VERSION}
 */
package ${SOURCES_PACKAGE};
EOF

        # Создаем MANIFEST для sources JAR
        mkdir -p "$BUILD_DIR/sources/META-INF"
        cat > "$BUILD_DIR/sources/META-INF/MANIFEST.MF" << EOF
Manifest-Version: 1.0
Created-By: Maven Publication Script
Implementation-Title: ${ARTIFACT_ID} Sources
Implementation-Version: ${VERSION}
Group-Id: ${GROUP_ID}
Artifact-Id: ${ARTIFACT_ID}
Sources-Package: ${SOURCES_PACKAGE}
EOF

        jar cf "$SOURCES_JAR" -C "$BUILD_DIR/sources" .
        log_success "Создан минимальный sources JAR с пакетом: $SOURCES_PACKAGE"
    fi
}

create_javadoc_jar() {
    log_info "Создание javadoc JAR..."
    mkdir -p "$BUILD_DIR/javadoc"

    # Создаем базовую HTML документацию
    cat > "$BUILD_DIR/javadoc/index.html" << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${ARTIFACT_ID} ${VERSION} - API Documentation</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        header { border-bottom: 2px solid #333; margin-bottom: 30px; padding-bottom: 20px; }
        h1 { color: #333; margin: 0; }
        .description { color: #666; margin-top: 10px; }
        .info { background: #f5f5f5; border-radius: 5px; padding: 15px; margin: 20px 0; }
        .info dt { font-weight: bold; margin-top: 10px; }
        .info dd { margin-left: 20px; }
        footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #777; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>${ARTIFACT_ID} ${VERSION}</h1>
            <p class="description">${PROJECT_DESCRIPTION}</p>
        </header>

        <section>
            <h2>Overview</h2>
            <p>This is the API documentation for ${ARTIFACT_ID} version ${VERSION}.</p>

            <div class="info">
                <dl>
                    <dt>Group ID:</dt>
                    <dd>${GROUP_ID}</dd>

                    <dt>Artifact ID:</dt>
                    <dd>${ARTIFACT_ID}</dd>

                    <dt>Version:</dt>
                    <dd>${VERSION}</dd>

                    <dt>Package:</dt>
                    <dd>${SOURCES_PACKAGE}</dd>

                    <dt>Project URL:</dt>
                    <dd><a href="${PROJECT_URL}">${PROJECT_URL}</a></dd>
                </dl>
            </div>

            <h2>Usage</h2>
            <p>Add the following dependency to your Maven project:</p>
            <pre style="background: #f8f8f8; padding: 15px; border-radius: 3px; overflow: auto;">
&lt;dependency&gt;
    &lt;groupId&gt;${GROUP_ID}&lt;/groupId&gt;
    &lt;artifactId&gt;${ARTIFACT_ID}&lt;/artifactId&gt;
    &lt;version&gt;${VERSION}&lt;/version&gt;
&lt;/dependency&gt;</pre>
        </section>

        <section>
            <h2>Package Summary</h2>
            <p>The main package is <strong>${SOURCES_PACKAGE}</strong>.</p>
        </section>

        <footer>
            <p>Generated by automated documentation generator.</p>
            <p>Documentation version: ${VERSION} | ${ARTIFACT_ID}</p>
        </footer>
    </div>
</body>
</html>
EOF

    # Создаем MANIFEST для javadoc JAR
    mkdir -p "$BUILD_DIR/javadoc/META-INF"
    cat > "$BUILD_DIR/javadoc/META-INF/MANIFEST.MF" << EOF
Manifest-Version: 1.0
Created-By: Maven Publication Script
Implementation-Title: ${ARTIFACT_ID} Javadoc
Implementation-Version: ${VERSION}
Group-Id: ${GROUP_ID}
Artifact-Id: ${ARTIFACT_ID}
Specification-Title: ${ARTIFACT_ID} API Documentation
Package: ${SOURCES_PACKAGE}
EOF

    jar cf "$JAVADOC_JAR" -C "$BUILD_DIR/javadoc" .
    log_success "Создан javadoc JAR"
}

check_main_jar() {
    log_info "Проверка основного JAR файла $FINAL_LIB_FILE..."
    if [ -f "$FINAL_LIB_FILE" ]; then
        log_success "Найден JAR файл: $FINAL_LIB_FILE"

        # Проверяем, что JAR файл валидный
        log_info "Проверка JAR файла..."
        if jar tf "$FINAL_LIB_FILE" &>/dev/null; then
            log_success "JAR файл валиден"
        else
            log_error "JAR файл поврежден или не является архивом"
            exit 1
        fi
    else
        log_error "Основной JAR файл не найден: $FINAL_LIB_FILE"
        echo ""
        echo "Убедитесь что файл существует в директории директории"
        echo ""
    fi
}

check_sources_jar() {
    log_info "Проверка sources JAR..."
    if [ -f "$SOURCES_JAR" ]; then
        log_success "Найден sources JAR: $SOURCES_JAR"

        # Проверяем валидность
        if jar tf "$SOURCES_JAR" &>/dev/null; then
            log_success "Sources JAR валиден"
        else
            log_warning "Sources JAR поврежден, создаем новый..."
            create_sources_jar
        fi
    else
        log_warning "Sources JAR не найден: $SOURCES_JAR"
        create_sources_jar
    fi
}

check_javadoc_jar() {
    log_info "Проверка javadoc JAR..."
    if [ -f "$JAVADOC_JAR" ]; then
        log_success "Найден javadoc JAR: $JAVADOC_JAR"

        # Проверяем валидность
        if jar tf "$JAVADOC_JAR" &>/dev/null; then
            log_success "Javadoc JAR валиден"
        else
            log_warning "Javadoc JAR поврежден, создаем новый..."
            create_javadoc_jar
        fi
    else
        log_warning "Javadoc JAR не найден: $JAVADOC_JAR"
        create_javadoc_jar
    fi
}

show_jars_info() {
    echo ""
    echo "Найденные JAR файлы:"
    echo "-------------------"
    echo ""

    # Показываем информацию о файлах
    for jar_file in "$FINAL_LIB_FILE" "$SOURCES_JAR" "$JAVADOC_JAR"; do
        if [ -f "$jar_file" ]; then
            file_size=$(ls -lh "$jar_file" | awk '{print $5}')
            echo "  ✓ $(basename "$jar_file") ($file_size)"
        else
            log_error "Файл не найден: $(basename "$jar_file")"
            return 0
        fi
    done

    echo ""
    echo "Настройки:"
    echo "  Group ID: $GROUP_ID"
    echo "  Artifact ID: $ARTIFACT_ID"
    echo "  Package: $SOURCES_PACKAGE"
    if [ -n "$SOURCE_CODE_PATH" ]; then
        echo "  Путь к исходникам: $SOURCE_CODE_PATH"
    else
        echo "  Путь к исходникам: не указан (создан минимальный)"
    fi

    echo ""
    log_success "JAR файлы проверены и готовы!"
    echo ""
}

# ===========================================
# ОСНОВНОЙ ВЫЗОВ ФУНКЦИЙ
# ===========================================

#log_step "2: Подготовка JAR файлов"

#create_work_dir
#check_main_jar
#check_sources_jar
#check_javadoc_jar
#show_jars_info